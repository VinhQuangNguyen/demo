<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0" />
    <title>Quảng Cáo Có Thưởng</title>

    <script async src="https://securepubads.g.doubleclick.net/tag/js/gpt.js"></script>

    <style>
      body {
        margin: 0;
        padding: 0;
        background: white;
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        font-family: Arial, sans-serif;
        overflow: hidden;
        position: fixed;
        width: 100%;
        height: 100%;
      }

      #watchAdButton {
        background: #007bff;
        color: white;
        padding: 20px 40px;
        border: none;
        border-radius: 8px;
        font-size: 18px;
        cursor: pointer;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        transition: all 0.2s ease;
        width: 80%;
        max-width: 300px;
        height: 60px;
        font-weight: bold;
      }

      #watchAdButton:active {
        background: #0056b3;
        transform: scale(0.95);
      }

      #watchAdButton:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
      }
    </style>

    <script>
      window.googletag = window.googletag || { cmd: [] };

      let rewardedSlot;
      let rewardPayload;
      let isAdReady = false;
      let isAdLoading = false;
      let retryCount = 0;
      let totalAttempts = 0;
      let isCooldownActive = false;
      let isSessionStopped = false;
      let activeTimeouts = [];
      let isLoadingRequested = false; // Chặn nhiều cuộc gọi load cùng lúc
      const MAX_RETRIES = 10;
      const MAX_ATTEMPTS_PER_SESSION = 10;
      const COOLDOWN_TIME = 10000; // 10 seconds

      console.log("Khởi tạo hệ thống quảng cáo...");

      function initializeAds() {
        console.log("Đang tạo slot quảng cáo...");
        rewardedSlot = googletag.defineOutOfPageSlot(
          "/22639388115/rewarded_web_example",
          googletag.enums.OutOfPageFormat.REWARDED
        );

        if (rewardedSlot) {
          console.log("Slot quảng cáo đã tạo thành công:", rewardedSlot);
          rewardedSlot.addService(googletag.pubads());

          googletag.pubads().addEventListener("rewardedSlotReady", (event) => {
            if (event.slot === rewardedSlot) {
              console.log("Quảng cáo đã sẵn sàng:", event);
              isAdReady = true;
              isAdLoading = false;
              isLoadingRequested = false; // Reset loading flag khi có quảng cáo
              window.rewardedEvent = event;
              updateStatus("Quảng cáo sẵn sàng!");
            }
          });

          googletag.pubads().addEventListener("rewardedSlotClosed", (event) => {
            if (event.slot === rewardedSlot) {
              console.log("Quảng cáo đã đóng:", event);
              console.log("Reward payload:", rewardPayload);

              // Show alert only if user completed the video (has reward)
              if (rewardPayload) {
                alert("Video đã xem xong! Cảm ơn bạn đã xem quảng cáo.");
              }

              dismissRewardedAd();
            }
          });

          googletag.pubads().addEventListener("rewardedSlotGranted", (event) => {
            if (event.slot === rewardedSlot) {
              console.log("Đã cấp thưởng:", event.payload);
              rewardPayload = event.payload;
            }
          });

          googletag.pubads().addEventListener("slotRenderEnded", (event) => {
            if (event.slot === rewardedSlot && event.isEmpty) {
              console.log("Slot trống, không có quảng cáo...");
              isAdReady = false;
              isAdLoading = false;
              isLoadingRequested = false; // Reset loading flag khi slot trống

              if (retryCount < MAX_RETRIES && totalAttempts < MAX_ATTEMPTS_PER_SESSION) {
                retryCount++;
                updateStatus(`Không có quảng cáo, thử lại (${retryCount}/${MAX_RETRIES})...`);

                // Tăng thời gian chờ giữa các lần retry: 3s, 6s, 9s...
                const delayTime = 3000 + (retryCount * 3000);

                const timeoutId = setTimeout(() => {
                  console.log(`Thử tải lại quảng cáo (${retryCount}/${MAX_RETRIES}) sau ${delayTime}ms...`);
                  autoLoadNewAd();
                }, delayTime);
                activeTimeouts.push(timeoutId);
              } else {
                updateStatus(`Đã thử ${MAX_RETRIES} lần, không có quảng cáo. Chờ 30 giây...`);
                retryCount = 0;

                // Đợi 30 giây trước khi thử lại
                const timeoutId = setTimeout(() => {
                  if (totalAttempts < MAX_ATTEMPTS_PER_SESSION && !isSessionStopped) {
                    autoLoadNewAd();
                  } else {
                    updateStatus("Đã thử quá nhiều lần. Vui lòng tải lại trang.");
                    stopAllRetries();
                  }
                }, 30000);
                activeTimeouts.push(timeoutId);
              }
            }
          });

          console.log("Đang enable services...");
          googletag.enableServices();
          console.log("Đang display slot...");
          googletag.display(rewardedSlot);
        } else {
          console.log("Không thể tạo slot quảng cáo");
          updateStatus("Không hỗ trợ quảng cáo");
        }
      }

      googletag.cmd.push(initializeAds);

      function dismissRewardedAd() {
        console.log("dismissRewardedAd called, rewardPayload:", rewardPayload);
        document.body.style.overflow = '';
        isAdReady = false;
        isLoadingRequested = false; // Reset loading flag khi dismiss
        window.rewardedEvent = null;

        if (rewardedSlot) {
          googletag.destroySlots([rewardedSlot]);
          console.log("Slot đã bị destroy");
          rewardedSlot = null;
        }

        const button = document.getElementById("watchAdButton");
        button.disabled = false;

        if (rewardPayload) {
          rewardPayload = null;
          updateStatus("Đã nhận thưởng!");
        } else {
          updateStatus("Quảng cáo đã đóng");
        }

        // Reset retry count và tự động tải quảng cáo mới
        // Chỉ auto-load nếu chưa vượt quá số lần thử tối đa VÀ chưa có quảng cáo sẵn sàng
        retryCount = 0;
        if (totalAttempts < MAX_ATTEMPTS_PER_SESSION && !isAdReady && !isSessionStopped) {
          // Nếu người dùng xem hết video (có reward), đợi 2 giây
          // Nếu ngắt giữa chừng (không có reward), đợi 1 giây để tải nhanh hơn
          const waitTime = rewardPayload ? 2000 : 1000;

          const timeoutId = setTimeout(() => {
            autoLoadNewAd();
          }, waitTime);
          activeTimeouts.push(timeoutId);

          if (rewardPayload) {
            console.log("Người dùng xem hết video, đợi 2 giây để tải quảng cáo mới...");
          } else {
            console.log("Người dùng ngắt giữa chừng, đợi 1 giây để tải quảng cáo mới...");
          }
        } else if (isAdReady) {
          console.log("Đã có quảng cáo sẵn sàng, không cần auto-load");
          updateStatus("Quảng cáo sẵn sàng!");
        } else {
          updateStatus("Đã thử nhiều lần, vui lòng tải lại trang để tiếp tục.");
          stopAllRetries();
        }
      }

      function autoLoadNewAd() {
        // Chặn nếu đang có process tải khác
        if (isLoadingRequested) {
          console.log("Đã có tiến trình tải đang chạy, bỏ qua yêu cầu mới...");
          return;
        }

        if (!isAdLoading && !isAdReady && totalAttempts < MAX_ATTEMPTS_PER_SESSION && !isSessionStopped) {
          console.log("Auto-loading quảng cáo mới...");
          console.log("Total attempts so far:", totalAttempts);

          totalAttempts++;
          updateStatus("Đang tải quảng cáo mới...");

          isAdLoading = true;
          isLoadingRequested = true;
          window.rewardedEvent = null;

          googletag.cmd.push(() => {
            console.log("Đang tạo slot mới (auto)...");
            initializeAds();
          });
        } else if (isAdReady) {
          console.log("Quảng cáo đã sẵn sàng, không cần load thêm");
          updateStatus("Quảng cáo đã sẵn sàng!");
          isLoadingRequested = false;
        } else if (totalAttempts >= MAX_ATTEMPTS_PER_SESSION || isSessionStopped) {
          console.log("Đã đạt tối đa số lần thử cho phiên này hoặc session đã dừng");
          updateStatus("Đã thử nhiều lần, vui lòng tải lại trang.");
          stopAllRetries();
        }
      }

      function stopAllRetries() {
        console.log("Dừng tất cả các timeout đang chờ...");
        isSessionStopped = true;

        // Hủy tất cả các timeout đang hoạt động
        activeTimeouts.forEach(timeoutId => {
          clearTimeout(timeoutId);
        });
        activeTimeouts = [];

        console.log("Đã dừng", activeTimeouts.length, "timeout");
      }

      function loadAd() {
        const button = document.getElementById("watchAdButton");

        console.log("loadAd called");
        console.log("isAdReady:", isAdReady);
        console.log("isAdLoading:", isAdLoading);
        console.log("rewardedEvent exists:", !!window.rewardedEvent);
        console.log("rewardedSlot exists:", !!rewardedSlot);
        console.log("totalAttempts:", totalAttempts);
        console.log("isSessionStopped:", isSessionStopped);

        if (isAdReady && window.rewardedEvent) {
          button.disabled = true;
          console.log("Đang hiển thị quảng cáo...");
          window.rewardedEvent.makeRewardedVisible();
          document.body.style.overflow = 'hidden';
          updateStatus("Đang xem quảng cáo...");
        } else if (isAdLoading) {
          console.log("Quảng cáo đang tự động tải, vui lòng đợi...");
          updateStatus("Đang tải quảng cáo...");
          button.disabled = false;
        } else if (totalAttempts >= MAX_ATTEMPTS_PER_SESSION || isSessionStopped) {
          console.log("Đã vượt quá số lần thử tối đa hoặc session đã dừng");
          updateStatus("Đã thử nhiều lần, vui lòng tải lại trang để tiếp tục.");
        } else if (!isAdReady) {
          console.log("Không có quảng cáo sẵn sàng, bắt đầu tải...");
          updateStatus("Đang tải quảng cáo...");

          // Nếu không có gì đang tải, bắt đầu auto-load ngay lập tức
          if (!isLoadingRequested) {
            autoLoadNewAd();
          } else {
            console.log("Đã có tiến trình tải đang chạy, vui lòng đợi...");
          }
        }
      }

      function updateStatus(message) {
        console.log("Status:", message);
      }
    </script>
  </head>
  <body>
    <button id="watchAdButton" onclick="loadAd()">Tải quảng cáo</button>
  </body>
</html>
<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0" />
    <title>Quảng Cáo Có Thưởng</title>

    <script async src="https://securepubads.g.doubleclick.net/tag/js/gpt.js"></script>

    <style>
      body {
        margin: 0;
        padding: 0;
        background: white;
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        font-family: Arial, sans-serif;
        overflow: hidden;
        position: fixed;
        width: 100%;
        height: 100%;
      }

      #watchAdButton {
        background: #007bff;
        color: white;
        padding: 20px 40px;
        border: none;
        border-radius: 8px;
        font-size: 18px;
        cursor: pointer;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        transition: all 0.2s ease;
        width: 80%;
        max-width: 300px;
        height: 60px;
        font-weight: bold;
      }

      #watchAdButton:active {
        background: #0056b3;
        transform: scale(0.95);
      }

      #watchAdButton:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
      }
    </style>

    <script>
      window.googletag = window.googletag || { cmd: [] };

      let rewardedSlot;
      let rewardPayload;
      let isAdReady = false;
      let isAdLoading = false;

      console.log("Khởi tạo hệ thống quảng cáo...");

      function initializeAds() {
        console.log("Đang tạo slot quảng cáo...");
        rewardedSlot = googletag.defineOutOfPageSlot(
          "/22639388115/rewarded_web_example",
          googletag.enums.OutOfPageFormat.REWARDED
        );

        if (rewardedSlot) {
          console.log("Slot quảng cáo đã tạo thành công:", rewardedSlot);
          rewardedSlot.addService(googletag.pubads());

          googletag.pubads().addEventListener("rewardedSlotReady", (event) => {
            if (event.slot === rewardedSlot) {
              console.log("Quảng cáo đã sẵn sàng:", event);
              isAdReady = true;
              isAdLoading = false;
              window.rewardedEvent = event;
              updateStatus("Quảng cáo sẵn sàng!");
            }
          });

          googletag.pubads().addEventListener("rewardedSlotClosed", (event) => {
            if (event.slot === rewardedSlot) {
              console.log("Quảng cáo đã đóng:", event);
              console.log("Reward payload:", rewardPayload);
              dismissRewardedAd();
            }
          });

          googletag.pubads().addEventListener("rewardedSlotGranted", (event) => {
            if (event.slot === rewardedSlot) {
              console.log("Đã cấp thưởng:", event.payload);
              rewardPayload = event.payload;
            }
          });

          googletag.pubads().addEventListener("slotRenderEnded", (event) => {
            if (event.slot === rewardedSlot && event.isEmpty) {
              console.log("Slot trống, không có quảng cáo");
              isAdReady = false;
              isAdLoading = false;
              updateStatus("Không có quảng cáo");
            }
          });

          console.log("Đang enable services...");
          googletag.enableServices();
          console.log("Đang display slot...");
          googletag.display(rewardedSlot);
        } else {
          console.log("Không thể tạo slot quảng cáo");
          updateStatus("Không hỗ trợ quảng cáo");
        }
      }

      googletag.cmd.push(initializeAds);

      function dismissRewardedAd() {
        console.log("dismissRewardedAd called, rewardPayload:", rewardPayload);
        document.body.style.overflow = '';
        isAdReady = false;
        window.rewardedEvent = null;

        if (rewardedSlot) {
          googletag.destroySlots([rewardedSlot]);
          console.log("Slot đã bị destroy");
          rewardedSlot = null;
        }

        const button = document.getElementById("watchAdButton");
        button.disabled = false;

        if (rewardPayload) {
          rewardPayload = null;
          updateStatus("Đã nhận thưởng!");
        } else {
          updateStatus("Quảng cáo đã đóng");
        }

        // Đợi 2 giây rồi tự động tải quảng cáo mới
        setTimeout(() => {
          autoLoadNewAd();
        }, 2000);
      }

      function autoLoadNewAd() {
        if (!isAdLoading && !isAdReady) {
          console.log("Auto-loading quảng cáo mới...");
          updateStatus("Đang tải quảng cáo mới...");

          isAdLoading = true;
          window.rewardedEvent = null;

          googletag.cmd.push(() => {
            console.log("Đang tạo slot mới (auto)...");
            initializeAds();
          });
        }
      }

      function loadAd() {
        const button = document.getElementById("watchAdButton");

        console.log("loadAd called");
        console.log("isAdReady:", isAdReady);
        console.log("isAdLoading:", isAdLoading);
        console.log("rewardedEvent exists:", !!window.rewardedEvent);
        console.log("rewardedSlot exists:", !!rewardedSlot);

        if (isAdReady && window.rewardedEvent) {
          button.disabled = true;
          console.log("Đang hiển thị quảng cáo...");
          window.rewardedEvent.makeRewardedVisible();
          document.body.style.overflow = 'hidden';
          updateStatus("Đang xem quảng cáo...");
        } else if (isAdLoading) {
          console.log("Quảng cáo đang tự động tải, vui lòng đợi...");
          updateStatus("Đang tải quảng cáo...");
          button.disabled = false;
        } else if (!isAdReady) {
          console.log("Không có quảng cáo sẵn sàng, bắt đầu tải...");
          updateStatus("Đang tải quảng cáo...");

          // Nếu không có gì đang tải, bắt đầu auto-load
          autoLoadNewAd();
        }
      }

      function updateStatus(message) {
        console.log("Status:", message);
      }
    </script>
  </head>
  <body>
    <button id="watchAdButton" onclick="loadAd()">Tải quảng cáo</button>
  </body>
</html>